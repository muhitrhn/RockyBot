import { MessageEmbed, MessageButton, MessageActionRow, InteractionCollector, CommandInteraction } from 'discord.js'
import { client, config } from "../.."

async function execute(interaction: CommandInteraction) {
  await interaction.defer()

  const mentioned = interaction.options.getMember('u≈ºytkownik') ? interaction.options.getMember('u≈ºytkownik') : interaction.member
  main(interaction, mentioned, null, null)
}

async function main(interaction: CommandInteraction, mentioned: any, bt: any, color: any) {
  const embed = new MessageEmbed()
    .setFooter(`üí° ${mentioned.user.tag}\nüõ†Ô∏è v${config.version} ‚îá ‚ö° RockyBot¬Æ 2021`, mentioned.user.displayAvatarURL({dynamic: true}))
    .setThumbnail(mentioned.user.displayAvatarURL({ dynamic: true }))
    .setTitle(`üíª  U≈ºytkownik ${mentioned.user.tag}`)
    .setDescription(
      `üõ°Ô∏è **${mentioned}**` + '\n' +
      `üìé ID: **${mentioned.user.id}**` + '\n' + 
      `${mentioned.nickname ? `${config.emotes.grverify} Nick: **${mentioned.nickname}**\n` : ''}` + '\n' +
      `‚è≤Ô∏è Konto za≈Ço≈ºone (UTC): **${mentioned.user.createdAt.getUTCHours()}:${(mentioned.user.createdAt.getUTCMinutes()<10?'0':'')+parseInt(mentioned.user.createdAt.getUTCMinutes())}‚îá${(mentioned.user.createdAt.getUTCDate()<10?'0':'')+parseInt(mentioned.user.createdAt.getUTCDate())}.${((mentioned.user.createdAt.getUTCMonth()+1)<10?'0':'')+parseInt(mentioned.user.createdAt.getUTCMonth()+1)}.${mentioned.user.createdAt.getUTCFullYear()}**` + '\n' +
      `${config.emotes.world} Do≈ÇƒÖczono do serwera (UTC): **${mentioned.joinedAt.getUTCHours()}:${(mentioned.joinedAt.getUTCMinutes()<10?'0':'')+parseInt(mentioned.joinedAt.getUTCMinutes())}‚îá${(mentioned.joinedAt.getUTCDate()<10?'0':'')+parseInt(mentioned.joinedAt.getUTCDate())}.${((mentioned.joinedAt.getUTCMonth()+1)<10?'0':'')+parseInt(mentioned.joinedAt.getUTCMonth()+1)}.${mentioned.joinedAt.getUTCFullYear()}**`
    )
    color ? embed.setColor(color) : embed.setColor('RANDOM'); const embedColor = embed.color

  if (mentioned.permissions.has('ADMINISTRATOR')) {
    const button = new MessageButton()
      .setLabel('Administrator')
      .setStyle('DANGER')
      .setEmoji(config.emotes.grverify_ID)
      .setCustomId('ch_perms')
      .setDisabled(true)

    const messageRow = new MessageActionRow().addComponents([button])

    await interaction.editReply({embeds: [embed], components: [messageRow]})
    return
  } 
      
  const button = new MessageButton()
    .setLabel('Permisje kana≈Çu')
    .setStyle('PRIMARY')
    .setEmoji('‚öíÔ∏è')
    .setCustomId('ch_perms')

  const button2 = new MessageButton()
    .setLabel('Permisje globalne')
    .setStyle('SUCCESS')
    .setEmoji('üõ†Ô∏è')
    .setCustomId('glob_perms')

  const messageRow = new MessageActionRow().addComponents([button, button2])

  // @ts-ignore  
  // eslint-disable-next-line no-empty
  try {await bt.deferUpdate()} catch (err) {} 

  const reply = await interaction.editReply({embeds: [embed], components: [messageRow]})

  //@ts-ignore
  const collector = new InteractionCollector(client, {message: reply, time: 30000, dispose: true})
  collector.on('collect', async buttonClick => {
    if (buttonClick.user.id !== interaction.user.id) {
      const replyEmbed = new MessageEmbed().setColor('RED').setDescription(`**${config.emotes.grverify} Nie wywo≈Ça≈Çe≈õ tej wiadomo≈õci**`).setFooter(`üõ†Ô∏è v${config.version} ‚îá ‚ö° RockyBot¬Æ 2021 Reply Engine`, // @ts-ignore  
        buttonClick.clicker.user.displayAvatarURL({dynamic: true}))
          
      // @ts-ignore  
      await buttonClick.reply.send({ embeds: [replyEmbed], ephemeral: true })
    } 
    // @ts-ignore  
    else if (buttonClick.customId === 'ch_perms') {
      collector.stop()

      chPerms(interaction, mentioned, buttonClick, embedColor)
      return
    } 
    // @ts-ignore  
    else if (buttonClick.customId === 'glob_perms') {
      collector.stop()

      globPerms(interaction, mentioned, buttonClick, embedColor)
      return
    }
  })
}

async function chPerms(interaction: CommandInteraction, mentioned: any, bt: any, color: any)  {
  const perms = [
    (mentioned.permissionsIn(interaction.channel).has('VIEW_CHANNEL') ? config.emotes.grverify : config.emotes.rverify) +  ' Wy≈õwietlanie kana≈Çu',
    (mentioned.permissionsIn(interaction.channel).has('SEND_MESSAGES') ? config.emotes.grverify : config.emotes.rverify) +  ' Wysy≈Çanie wiadomo≈õci',
    (mentioned.permissionsIn(interaction.channel).has('ADD_REACTIONS') ? config.emotes.grverify : config.emotes.rverify) +  ' Dodawanie reakcji',
    (mentioned.permissionsIn(interaction.channel).has('SEND_TTS_MESSAGES') ? config.emotes.grverify : config.emotes.rverify) +  ' Wysy≈Çanie wiadomo≈õci TTS',
    (mentioned.permissionsIn(interaction.channel).has('ATTACH_FILES') ? config.emotes.grverify : config.emotes.rverify) +  ' Za≈ÇƒÖczanie plik√≥w',
    (mentioned.permissionsIn(interaction.channel).has('READ_MESSAGE_HISTORY') ? config.emotes.grverify : config.emotes.rverify) +  ' Wy≈õwietlanie historii czatu',
    (mentioned.permissionsIn(interaction.channel).has('USE_EXTERNAL_EMOJIS') ? config.emotes.grverify : config.emotes.rverify) +  ' U≈ºywanie zewnƒôtrznych emoji',
    (mentioned.permissionsIn(interaction.channel).has('MENTION_EVERYONE') ? config.emotes.grverify : config.emotes.rverify) +  ' U≈ºywanie wzmianki "everyone"',
    (mentioned.permissionsIn(interaction.channel).has('MANAGE_MESSAGES') ? config.emotes.grverify : config.emotes.rverify) +  ' ZarzƒÖdzanie wiadomo≈õciami'
  ]
  
  const embed = new MessageEmbed()
    .setFooter(`üí° ${mentioned.user.tag}\nüõ†Ô∏è v${config.version} ‚îá ‚ö° RockyBot¬Æ 2021`, mentioned.user.displayAvatarURL({dynamic: true}))
    .setThumbnail(mentioned.user.displayAvatarURL({ dynamic: true }))
    //@ts-ignore
    .setTitle(`${config.emotes.warn} Uprawnienia na kanale ${interaction.channel.name} dla ${mentioned.user.tag}`)
    .setColor(color)
    .addField('üì° Uprawnienia na kanale:', perms.join('\n'))

  const button = new MessageButton()
    .setLabel('Wr√≥ƒá')
    .setStyle('SECONDARY')
    .setEmoji(config.emotes.arrl_ID)
    .setCustomId('back')

  const messageRow = new MessageActionRow().addComponents([button])

  // @ts-ignore  
  await bt.deferUpdate()

  const reply = await interaction.editReply({embeds: [embed], components: [messageRow]})
      
  //@ts-ignore
  const collector = new InteractionCollector(client, {message: reply, time: 30000, dispose: true})
  collector.on('collect', async buttonClick => {
    if (buttonClick.user.id !== interaction.user.id) {
      const replyEmbed = new MessageEmbed().setColor('RED').setDescription(`**${config.emotes.grverify} Nie wywo≈Ça≈Çe≈õ tej wiadomo≈õci**`).setFooter(`üõ†Ô∏è v${config.version} ‚îá ‚ö° RockyBot¬Æ 2021 Reply Engine`, // @ts-ignore  
        buttonClick.clicker.user.displayAvatarURL({dynamic: true}))
          
       // @ts-ignore  
      await buttonClick.reply.send({ embeds: [replyEmbed], ephemeral: true })
    } 
    // @ts-ignore  
    else if (buttonClick.customId === 'back'){
      collector.stop()
          
      main(interaction, mentioned, buttonClick, color)
      return
    }
  })
}

async function globPerms(interaction: CommandInteraction, mentioned: any, bt: any, color: any)  {
  const serverperms = [
    (mentioned.permissions.has('BAN_MEMBERS') ? config.emotes.grverify : config.emotes.rverify) +  ' Banowanie cz≈Çonk√≥w',
    (mentioned.permissions.has('KICK_MEMBERS') ? config.emotes.grverify : config.emotes.rverify) +  ' Wyrzucanie cz≈Çonk√≥w',
    (mentioned.permissions.has('VIEW_AUDIT_LOG') ? config.emotes.grverify : config.emotes.rverify) +  ' Wy≈õwietlanie dziennika zdarze≈Ñ',
    (mentioned.permissions.has('MANAGE_GUILD') ? config.emotes.grverify : config.emotes.rverify) +  ' ZarzƒÖdzanie serwerem',
    (mentioned.permissions.has('MANAGE_CHANNELS') ? config.emotes.grverify : config.emotes.rverify) +  ' ZarzƒÖdzanie kana≈Çami',
    (mentioned.permissions.has('MANAGE_ROLES') ? config.emotes.grverify : config.emotes.rverify) +  ' ZarzƒÖdzanie rolami i permisjami',
    (mentioned.permissions.has('MANAGE_EMOJIS') ? config.emotes.grverify : config.emotes.rverify) +  ' ZarzƒÖdzanie emoji',
    (mentioned.permissions.has('MANAGE_NICKNAMES') ? config.emotes.grverify : config.emotes.rverify) +  ' ZarzƒÖdzanie pseudonimami',
    (mentioned.permissions.has('VIEW_GUILD_INSIGHTS') ? config.emotes.grverify : config.emotes.rverify) +  ' Wy≈õwietlanie informacji o serwerze',
    (mentioned.permissions.has('CREATE_INSTANT_INVITE') ? config.emotes.grverify : config.emotes.rverify) +  ' Tworzenie szybkich zaprosze≈Ñ'
  ]
  
  const voiceperms = [
    (mentioned.permissions.has('CONNECT') ? config.emotes.grverify : config.emotes.rverify) +  ' ≈ÅƒÖczenie',
    (mentioned.permissions.has('SPEAK') ? config.emotes.grverify : config.emotes.rverify) +  ' Rozmowa',
    (mentioned.permissions.has('STREAM') ? config.emotes.grverify : config.emotes.rverify) +  ' Wideo',
    (mentioned.permissions.has('PRIORITY_SPEAKER') ? config.emotes.grverify : config.emotes.rverify) +  ' Priorytetowy rozm√≥wca',
    (mentioned.permissions.has('DEAFEN_MEMBERS') ? config.emotes.grverify : config.emotes.rverify) +  ' Wyciszanie innych u≈ºytkownik√≥w',
    (mentioned.permissions.has('MOVE_MEMBERS') ? config.emotes.grverify : config.emotes.rverify) +  ' Przenoszenie innych u≈ºytkownik√≥w'
  ]
      
  const embed = new MessageEmbed()
    .setFooter(`üí° ${mentioned.user.tag}\nüõ†Ô∏è v${config.version} ‚îá ‚ö° RockyBot¬Æ 2021`, mentioned.user.displayAvatarURL({dynamic: true}))
    .setThumbnail(mentioned.user.displayAvatarURL({ dynamic: true }))
    .setTitle(`${config.emotes.world} Uprawnienia na serwerze dla ${mentioned.user.tag}`)
    .setColor(color)
    .addField(`${config.emotes.staff} ZarzƒÖdzanie serwerem:`, serverperms.join('\n'))
    .addField('üó£Ô∏è Kana≈Çy g≈Çosowe', voiceperms.join('\n'))

  const button = new MessageButton()
    .setLabel('Wr√≥ƒá')
    .setStyle('SECONDARY')
    .setEmoji(config.emotes.arrl_ID)
    .setCustomId('back')

  const messageRow = new MessageActionRow().addComponents([button])
      
  // @ts-ignore  
  await bt.deferUpdate()

  const reply = await interaction.editReply({embeds: [embed], components: [messageRow]})

  //@ts-ignore
  const collector = new InteractionCollector(client, {message: reply, time: 30000, dispose: true})
  collector.on('collect', async buttonClick => {
    if (buttonClick.user.id !== interaction.user.id) {
      const replyEmbed = new MessageEmbed().setColor('RED').setDescription(`**${config.emotes.grverify} Nie wywo≈Ça≈Çe≈õ tej wiadomo≈õci**`).setFooter(`üõ†Ô∏è v${config.version} ‚îá ‚ö° RockyBot¬Æ 2021 Reply Engine`, // @ts-ignore  
        buttonClick.clicker.user.displayAvatarURL({dynamic: true}))
          
      // @ts-ignore  
      await buttonClick.reply.send({ embeds: [replyEmbed], ephemeral: true })
    } 
    // @ts-ignore  
    else if (buttonClick.customId === 'back'){
      collector.stop()
          
      main(interaction, mentioned, buttonClick, color)
      return
    }
  }) 
}

const options = {
  name: 'userinfo',
  description: 'üë§ Info o u≈ºytkowniku',
  type: 1,
  options: [
    {
      type: 'USER',
      name: 'u≈ºytkownik',
      description: 'üë• U≈ºytkownik, o kt√≥rym wy≈õwietlƒÖ siƒô informacje',
      required: false
    }
  ]
}

export { execute, options }